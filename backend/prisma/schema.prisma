// This is your Prisma schema file for THISTHAT V1
// V1 Scope: Credits-based prediction market system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Core user data with credits
model User {
  id                  String   @id @default(uuid()) @db.Uuid
  username            String   @unique @db.VarChar(50)
  email               String   @unique @db.VarChar(255)
  name                String?  @db.VarChar(100) // Display name
  passwordHash        String   @map("password_hash") @db.VarChar(255)

  // Credits system (V1 only)
  creditBalance       Decimal  @default(1000.00) @map("credit_balance") @db.Decimal(18, 2)
  totalVolume         Decimal  @default(0.00) @map("total_volume") @db.Decimal(18, 2)
  overallPnL          Decimal  @default(0.00) @map("overall_pnl") @db.Decimal(18, 2)

  // Leaderboard rankings
  rankByPnL           Int?     @map("rank_by_pnl")
  rankByVolume        Int?     @map("rank_by_volume")

  // Daily rewards tracking
  lastDailyRewardAt   DateTime? @map("last_daily_reward_at") @db.Timestamp()

  // Timestamps
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamp()

  // Relations
  bets                Bet[]
  creditTransactions  CreditTransaction[]
  dailyRewards        DailyReward[]
  refreshTokens       RefreshToken[]

  @@index([username])
  @@index([email])
  @@index([rankByPnL])
  @@index([rankByVolume])
  @@map("users")
}

// Market model - Prediction markets (Polymarket + admin-created)
model Market {
  id              String   @id @default(uuid()) @db.Uuid
  polymarketId    String?  @unique @map("polymarket_id") @db.VarChar(255)

  title           String   @db.VarChar(500)
  description     String?  @db.Text

  // Binary options (THIS/THAT)
  thisOption      String   @map("this_option") @db.VarChar(255)
  thatOption      String   @map("that_option") @db.VarChar(255)

  // Odds (e.g., 0.6500 = 65%)
  thisOdds        Decimal  @map("this_odds") @db.Decimal(5, 4)
  thatOdds        Decimal  @map("that_odds") @db.Decimal(5, 4)

  // Market metadata
  liquidity       Decimal? @db.Decimal(18, 2)
  category        String?  @db.VarChar(100)
  marketType      String   @default("polymarket") @map("market_type") @db.VarChar(50) // 'credits', 'polymarket', 'cross'
  status          String   @default("open") @db.VarChar(50) // 'open', 'closed', 'resolved', 'cancelled'
  resolution      String?  @db.VarChar(50) // 'this', 'that', 'invalid'

  // Timing
  expiresAt       DateTime? @map("expires_at") @db.Timestamp()
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamp()
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp()
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamp()

  // Relations
  bets            Bet[]

  @@index([status])
  @@index([category])
  @@index([marketType])
  @@index([polymarketId])
  @@map("markets")
}

// Bet model - User bets on markets
model Bet {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  marketId         String   @map("market_id") @db.Uuid

  amount           Decimal  @db.Decimal(18, 2)
  side             String   @db.VarChar(10) // 'this' or 'that'
  oddsAtBet        Decimal  @map("odds_at_bet") @db.Decimal(5, 4)
  potentialPayout  Decimal  @map("potential_payout") @db.Decimal(18, 2)
  actualPayout     Decimal? @map("actual_payout") @db.Decimal(18, 2)

  status           String   @default("pending") @db.VarChar(50) // 'pending', 'won', 'lost', 'cancelled'

  placedAt         DateTime @default(now()) @map("placed_at") @db.Timestamp()
  resolvedAt       DateTime? @map("resolved_at") @db.Timestamp()

  // Relations
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  market           Market   @relation(fields: [marketId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([marketId])
  @@index([status])
  @@index([placedAt(sort: Desc)])
  @@map("bets")
}

// CreditTransaction model - Audit trail for all credit movements
model CreditTransaction {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid

  amount          Decimal  @db.Decimal(18, 2) // Positive = credit, negative = debit
  transactionType String   @map("transaction_type") @db.VarChar(50) // 'daily_reward', 'bet_placed', 'bet_payout', 'purchase'
  referenceId     String?  @map("reference_id") @db.Uuid // Bet ID or reward ID
  balanceAfter    Decimal  @map("balance_after") @db.Decimal(18, 2)

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("credit_transactions")
}

// DailyReward model - Track daily login rewards
model DailyReward {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String   @map("user_id") @db.Uuid

  creditsAwarded  Decimal  @default(100.00) @map("credits_awarded") @db.Decimal(18, 2)
  claimedAt       DateTime @default(now()) @map("claimed_at") @db.Timestamp()

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([claimedAt(sort: Desc)])
  @@map("daily_rewards")
}

// RefreshToken model - JWT refresh token management
model RefreshToken {
  id          String   @id @default(uuid()) @db.Uuid
  userId      String   @map("user_id") @db.Uuid

  tokenHash   String   @unique @map("token_hash") @db.VarChar(255)
  expiresAt   DateTime @map("expires_at") @db.Timestamp()
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp()

  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tokenHash])
  @@index([userId])
  @@map("refresh_tokens")
}
